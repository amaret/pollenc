starting riemann with:
  bin/riemann -Djava.net.preferIPv4Stack=true etc/riemann.config  &

Security Groups associated with i-8421226f
Ports	Protocol	Source	vpc-dev
All	All	sg-00380165	✔
All	All	sg-4f68562a	✔
4567	tcp	sg-52685637	✔
4567	tcp	sg-4f68562a	✔
22	tcp	0.0.0.0/0	✔
80	tcp	0.0.0.0/0	✔
All	All	sg-52685637	✔
443	tcp	0.0.0.0/0	✔
4567	tcp	sg-00380165	

netstat -nl
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State      
tcp        0      0 127.0.0.1:11211         0.0.0.0:*               LISTEN     
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN     
tcp        0      0 10.0.0.11:4567          0.0.0.0:*               LISTEN     
tcp        0      0 0.0.0.0:45880           0.0.0.0:*               LISTEN     
tcp6       0      0 :::80                   :::*                    LISTEN     
tcp6       0      0 :::4369                 :::*                    LISTEN     
tcp6       0      0 10.0.0.11:5555          :::*                    LISTEN     
tcp6       0      0 10.0.0.11:5556          :::*                    LISTEN     
tcp6       0      0 :::22                   :::*                    LISTEN     
tcp6       0      0 :::5672                 :::*                    LISTEN     
udp        0      0 0.0.0.0:23236           0.0.0.0:*                          
udp        0      0 127.0.0.1:11211         0.0.0.0:*                          
udp        0      0 0.0.0.0:68              0.0.0.0:*                          
udp6       0      0 10.0.0.11:5555          :::*                               
udp6       0      0 :::23149                :::*     

1. 
IP; using port 4567
private IP in riemann config and dash config: 10.0.0.11
Accessed: 
http://54.172.212.93:4567/                                       // This webpage is not available
http://http://ec2-54-172-212-93.compute-1.amazonaws.com:4567/    // This webpage is not available

2. 
Used 127.0.0.1 for IP in riemann.config and defaults to riemann-dash.
Same errors as above.

3. 
Used the public IP addr 54.172.212.93

ERROR [2014-10-15 00:14:33,269] main - riemann.bin - Couldn't start
java.util.concurrent.ExecutionException: org.jboss.netty.channel.ChannelException: Failed to bind to: /54.172.212.93:5556
Same error with
  bin/riemann etc/riemann.config  &
With riemann-dash this IP addr gets:
[2014-10-15 00:23:18] WARN  TCPServer Error: Cannot assign requested address - bind(2)
/var/lib/gems/1.9.1/gems/webrick-1.3.1/lib/webrick/utils.rb:85:in `initialize': Cannot assign requested address - bind(2) (Errno::EADDRNOTAVAIL

4. 
Added 4567 to inbound, outbound rules as 0.0.0.0/0 (open to the outside world).
Worked. 

5. 
Ran riemann-dash with localhost instead of local IP of riemann server and it did not work.
Ran riemann-health with localhost instead of local IP of riemann server and it did not work.

6. 
Tried changing riemann-config host to 0.0.0.0 and as long as everything else came up with local IP 
this worked but same problem (socket error) in riemann-dash.
Riemann-dash is okay with '0.0.0.0'

7. 
Tried opening 5555 and 5556 to world in security group and caused riemann to get an exception. 
However can't telnet to IP:5555 so I'm going to check further. 
8. 
After removing 0.0.0.0 from riemann-dash config and riemann.config and going 
back to local IP in those places 
AND keeping the opening of ports 5555/5556 I got data into riemann-dash.
BUT I'm getting aborts in the riemann.log.
Aborted first riemann-dash, then riemann-health and still the errors:
  INFO [2014-10-15 18:51:03,371] New I/O worker #6 - 
  riemann.transport.websockets - Websocket connection from 
  204.28.116.90 /index subscribe=true&query=all
  line 1:0 no viable alternative at input 'all'
  WARN [2014-10-15 18:51:03,372] New I/O worker #6 - 
  riemann.transport.websockets - ws-handler caught; closing 
  websocket connection.
  clojure.lang.ExceptionInfo: throw+: {:type :riemann.query/parse-error, 
  :message "invalid term \"all\""} {:object {:type :riemann.query/parse-error, 
  :message "invalid term \"all\""}, 
  :environment {node #<CommonErrorNode 
  <unexpected: [@0,0:2='all',<20>,1:0], resync=all>>, 
  n "all", kids (), G__8649 "all", term all}}
I wonder if this comes from riemann.config?
I killed everything and started riemann and I'm getting this error. 
Perhaps riemann.config was contamninated. 
No, it wasn't. 
I think this was coming from the queries from the riemann-dash loaded in my browser. 
I had killed the view and killed the riemann-dash job but the query lived on. 
'all' as a query is bad news, tho it is in the list (?).

9.
WHAT WORKS: 
upper right box in dash has 54.172.212.93:5556
Ports 5555 & 5556 are open incoming to the world in security group vpc-dev.
riemann.config and dash config specify IP addr that is private to vpc.
The query to dash used 'host' (not 'all').
   
10.
Tried to move to contol.amaret.com. My security groups no longer work. The rules
are listed but 5555 is not open.
At link https://forums.aws.amazon.com/thread.jspa?threadID=113766:

  Re: EC2 Security group rule not working
  Posted by:   webops
  Posted on: Jan 17, 2013 10:31 AM
  in response to: Brandon@AWS in response to: Brandon@AWS

  Brandon thanks for all your help on this, I've managed to figure out the
  issue.  The tip about the private IP address was the key - I was looking at
  the destination server's configuration and rules when I should have been
  looking at the client's email relay configuration.  The email relay on the
  connecting server was set to the domain name of the destination server, not
  the private IP, thereby disabling the connection by security group rule. I
  changed that to the private IP of the destination server, disabled the
  0.0.0.0/0 rule on the port, limiting access to just the security group, and
  was able to connect.  Thanks again -

I tried changing everything with the security groups and I 
think the reason why 5555 didn't show up is because
nothing was listening and I think this may have been happening because the
riemann.log has only this: 
  riemann.graphite - Connecting to  {:port 2003, :host 10.0.0.6/a/graphite}
over and over. 
So this connection failed? On the machine running graphite the 2003 graphite
port is opened but not the 5555 port.

I am able to connect when I change 
   (def graph (graphite {:host "10.0.0.6/a/graphite"}))
to
   (def graph (graphite {:host "10.0.0.6"}))
in riemann.config.

However then I get 
  java.lang.IllegalArgumentException: won't conj service: 
     #riemann.service.ThreadService{:name :riemann.core/reaper, 
from the clojure compiler

Looking into the graphite issue I find this:
  https://answers.launchpad.net/graphite/+question/189080   
    // feature request to serve graphite from a suburl
  https://github.com/graphite-project/graphite-web/pull/797 
    // thread on the patch, very recent.
This is not released in a official version, there is this patch available.
Using the patch doesn't mean that it will necessarily work with riemann however
though it might. 
    
11.
I was able to get riemann-dash up on the control.amaret.com server but I'm going 
to abandon it as it has a graphite install and I've decided not to use that. 

12.
Back to 10.0.0.11. 

Riemann NOTES: 
Example Tags for riemann-health:
riemann-health --host 127.0.0.1 --tag "prod" --tag "webserver"

Riemann-dash:

We run with dash.config:
  set :bind, "10.0.0.11"		# private ip req'd for AWS
  config[:ws_config] = '/home/ops/riemann/riemann-dash/config.json' # custom workspace config


  With command line 'riemann-health --host 127.0.0.1 --tag "prod" --tag "webserver"'
    In the dash, events from this invocation will include two extra tags "prod" and
    "webserver". On the dashboard side, you can create a grid view which contains
    the following query:
    
    (tagged "prod" and tagged "webserver")
    
    The tagged keyword in the query ensures that the given tag is present in the
    list of tags for a given event. This query will return only "prod" and
    "webservers" hosts.
  
  If you think of the riemann dashboard as a set of rows (hosts) and 
  columns (events/states) you can select only certain columns 
  in the dashboard. Use 'service':
  
    service =~ "cpu"  // for example
  
  To split a view: control-command-arrow
  
  Saving config.json:
  riemann-dash will overwrite the config.json file with defaults if a file exists
  in that directory. DELETE the existing config.json and it will write a config
  file that reflects the current state of the graph definitions. 

  NOTE I had to run the upstart script with setuid of ops or the save of the
  config file failed with a permissions problem.
  (I think the install isn't quite right. The config dir has a riemann:riemann
  group user.)
  The config file default location is here:
    /var/lib/gems/1.9.1/gems/riemann-dash-0.2.9/config/config.json
  we change this via dash-config, see above. 
  
  To eliminate events/sec which seems to always be nil. This does only a load of system
  services:
  (tagged "riemann_server" and (service = "cpu" or service = "load" or service = "disk /" or service = "memory"))
  
  queries:
    service =~ "events_per_sec"           for rate
    service =~ "riemann server tcp 10.0.0.11:5555 in latency 0.95"
  
  Riemann-dash log:
  
  /var/log/upstart/riemann-dash.log

13.
riemann_health services:

  service cpu, 
  service disk /, 
  service load, 
  service memory, 
  service riemann netty execution-handler queue size, 
  service riemann netty execution-handler threads active, 
  service riemann server tcp 10.0.0.11:5555 conns, 
  service riemann server tcp 10.0.0.11:5555 in latency 0.0, 
  service riemann server tcp 10.0.0.11:5555 in latency 0.5, 
  service riemann server tcp 10.0.0.11:5555 in latency 0.95, 
  service riemann server tcp 10.0.0.11:5555 in latency 0.99, 
  service riemann server tcp 10.0.0.11:5555 in latency 0.999, 
  service riemann server tcp 10.0.0.11:5555 in rate, 
  service riemann server udp 10.0.0.11:5555 in latency 0.0, 
  service riemann server udp 10.0.0.11:5555 in latency 0.5, 
  service riemann server udp 10.0.0.11:5555 in latency 0.95, 
  service riemann server udp 10.0.0.11:5555 in latency 0.99, 
  service riemann server udp 10.0.0.11:5555 in latency 0.999, 
  service riemann server udp 10.0.0.11:5555 in rate, 
  service riemann server ws 10.0.0.11:5556 conns, 
  service riemann server ws 10.0.0.11:5556 in latency 0.0, 
  service riemann server ws 10.0.0.11:5556 in latency 0.5, 
  service riemann server ws 10.0.0.11:5556 in latency 0.95, 
  service riemann server ws 10.0.0.11:5556 in latency 0.99, 
  service riemann server ws 10.0.0.11:5556 in latency 0.999, 
  service riemann server ws 10.0.0.11:5556 in rate, 
  service riemann server ws 10.0.0.11:5556 out latency 0.0, 
  service riemann server ws 10.0.0.11:5556 out latency 0.5, 
  service riemann server ws 10.0.0.11:5556 out latency 0.95, 
  service riemann server ws 10.0.0.11:5556 out latency 0.99, 
  service riemann server ws 10.0.0.11:5556 out latency 0.999, 
  service riemann server ws 10.0.0.11:5556 out rate, 
  service riemann streams latency 0.0, 
  service riemann streams latency 0.5, 
  service riemann streams latency 0.95, 
  service riemann streams latency 0.99, 
  service riemann streams latency 0.999, 
  service riemann streams rate, 

14.
for pcc.amaret.com:
riemann-dash is not showing a smooth graph. It flickers across two views of the
data. Some lines are not drawn. E.g. a view of pcc.amaret.com cpu and a view of
all services (no pcc.amaret.com displayed). 
I think this is due to data points that shift scale: from highest value of .35
to highest value of .14. This causes redrawing that loses display data. 
So metrics are inconsistent for this machine?
Could this be valid for a machine with very little activity?

15.
Flicker, skew. 
I am having trouble getting all the machies to interact nicely with the dash.
In particular pcc.amaret.com data causes flicker and redrawing that loses the
data for other machines. When I turned off riemann-health for other machines 
it draws with gaps in the data.
There are also progressions in the graph according to time and then it slips 
to the right. Skew?

I have a graph of all services from pcc.amaret.com. 
If any othem machine is sending data to the dash, this is blank. 
On this machine the load is always 0. 

Kyle: Sounds to me like server1's clock is running far ahead of image1, and it's 
dragging the dashboard into the future (where it thinks image1's data is 
out-of-date and should not be rendered). See 
http://riemann.io/howto.html#troubleshooting-missing-events, which has a section 
on clock skew. 

I installed ntp on all machines and go the daemons running so wherefrom the 
skew?

It turned out that the updates were not happening because UDP port 123
has to be open incoming & outgoing. The updates were failing to sync because
of security group and there was no warning because it defaulted to sync'ing 
with 127.0.0.1.

Opened the port and it sync'd.

16.
String Regex for Redis Keys in clojure:
(defn numkeys [stringthing] (def x (re-find #"=?\d+," stringthing)) (re-find #"\d+" x))

parm:
"db0:keys=1,expires=0,avg_ttl=0"

this extracts the number of keys
This worked, it creates a new event and sends it to the index:
       ; get redis keyspace size
       (where (tagged "riemann-redis-keyspace")
         (smap
         (fn [event]
             (let [stringthing (format "%s" (:state event)) keys (num-redis-keys
stringthing)]
                     riemann.common/event {:service "redis_queue_size"
                                           :time  (:time event)
                                           :metric keys
                                           :host (:host event)
                                           :description "num-keys-redis-db"
                                           }
             )
          )
          #(info %)
          index
          )
       )



17.
The db series names are created in riemann.config.
It is <host>.<service>:
      ; influxdb series
        (fn [event]
            (let [series (format "%s.%s" (:host event) (:service event))]
                (influx series {
                    :time  (:time event)
                    :value (:metric event)
                })
            )
        )
